{% extends 'Student/base.html' %}

{% block content %}
<div class="container">

    {% if errors %}
        <p style="color: red;">{{ errors }}</p>
    {% endif %}

    <h1>Create New Quiz</h1>

    <form method="post">
        {% csrf_token %}

        <div>
            <h3>Quiz Details</h3>
            {{ quizform.as_p }}
        </div>

        <h3>Questions</h3>
        {{ formset.management_form }}
        <div id="questions">
            {% for form in formset %}
                <div>
                    {{ form.id }}
                    <div>
                        {{ form.question_statement.label_tag }}
                        {{ form.question_statement }}
                    </div>
                    <div>
                        {{ form.question_type.label_tag }}
                        {{ form.question_type }}
                    </div>
                    <div>
                        {{ form.difficulty_level.label_tag }}
                        {{ form.difficulty_level }}
                    </div>
                    <div>
                        {{ form.correct_answer.label_tag }}
                        {{ form.correct_answer }}
                    </div>

                    <div>
                        {{ form.options.management_form }}
                        {% for option_form in form.options %}
                            <div>
                                {{ option_form.id }}
                                {{ option_form.option_text.label_tag }}
                                {{ option_form.option_text }}
                            </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-option">Add Option</button>
                </div>
            {% endfor %}
        </div>

        <button type="button" id="add-question">Add Question</button>
        <button type="submit">Submit</button>
    </form>
</div>

<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
        var addButton = document.getElementById("add-question");
        var formContainer = document.getElementById("questions");
        var formIndex = formContainer.children.length;

        addButton.addEventListener("click", function () {
            var newForm = formContainer.children[0].cloneNode(true);
            formIndex++;
            var formRegex = RegExp(`form-(\\d){1}-`, 'g');
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, `form-${formIndex}-`);
            var inputs = newForm.querySelectorAll('input, textarea, select');
            inputs.forEach(input => input.value = '');
            formContainer.appendChild(newForm);
            document.getElementById("id_form-TOTAL_FORMS").value = formIndex + 1;
        });

        formContainer.addEventListener("click", function (event) {
            if (event.target.classList.contains("add-option")) {
                var optionFormSet = event.target.closest("div").querySelector("div");
                var totalForms = optionFormSet.querySelectorAll("div").length;
                var prefix = optionFormSet.querySelector('input').name.split('-')[0];
                var newOptionForm = document.createElement('div');
                newOptionForm.innerHTML = `
                    <div>
                        <input type="hidden" name="${prefix}-options-${totalForms}-id" />
                        <label for="id_${prefix}-options-${totalForms}-option_text">Option:</label>
                        <input type="text" name="${prefix}-options-${totalForms}-option_text" />
                    </div>
                `;
                optionFormSet.appendChild(newOptionForm);
                document.getElementById(`${prefix}-options-TOTAL_FORMS`).value = totalForms + 1;
            }
        });
    });
</script>
{% endblock %}
