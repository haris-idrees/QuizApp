{% extends 'Student/base.html' %}

{% block content %}

<div class="container">
    <h1>Create Quiz</h1>
    <form id="quiz-form" method="post">
        {% csrf_token %}
        {{ quizform.as_p }}
        <h2>Add Question</h2>
        <div id="questions_formset">
            {{ question_formset.management_form }}
            {% for form in question_formset %}
                <div class="question-form">
                    {{ form.as_p }}
                    <button type="button" class="remove-question">Remove Question</button>
                </div>
                <div id="options_formset">
                    {{ options_formset.management_form }}
                    {% for option_form in options_formset %}
                        <div class="option-form">
                            {{ option_form.as_p }}
                            <button type="button" class="remove-option">Remove Option</button>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        <button type="button" id="add-option">Add Option</button>
        </div>
        <button type="button" id="add-question">Add Question</button>
        <button type="submit">Save</button>
    </form>
</div>
<script>


document.addEventListener('DOMContentLoaded', function() {
    let questionForms = document.querySelectorAll(".question-form");
    let question_container = document.querySelector("#questions_formset");
    let addQuestionButton = document.querySelector("#add-question");
    let totalQuestionForms = document.querySelector("#id_questions-TOTAL_FORMS");


    let optionForms = document.querySelectorAll(".option-form");
    let option_container = document.querySelector("#options_formset");
    let addOptionButton = document.querySelector("#add-option");
    let totalOptionForms = document.querySelector("#id_options-TOTAL_FORMS");

    if (!totalQuestionForms) {
        console.error("Element with id 'id_questions-TOTAL_FORMS' not found.");
        return;
    }

    if (!totalOptionForms) {
        console.error("Element with id 'id_options-TOTAL_FORMS' not found.");
        return;
    }

    let QuestionformNum = questionForms.length - 1;
    addQuestionButton.addEventListener('click', addQuestionForm);

    let OptionformNum = optionForms.length - 1;
    addOptionButton.addEventListener('click', addOptionForm);


    function addQuestionForm(e) {
        e.preventDefault();

        let newForm = questionForms[0].cloneNode(true);
        let formRegex = /questions-(\d+)-/g;

        QuestionformNum++;
        newForm.innerHTML = newForm.innerHTML.replace(formRegex, `questions-${QuestionformNum}-`);

        // Update the ID and name attributes of the new form fields
        let formFields = newForm.querySelectorAll('input, select, textarea, label');
        formFields.forEach(function(field) {
            if (field.id) {
                console.log(`Updating field id from ${field.id} to ${field.id.replace(formRegex, `questions-${QuestionformNum}-`)}`);
                field.id = field.id.replace(formRegex, `questions-${QuestionformNum}-`);
            }
            if (field.name) {
                console.log(`Updating field name from ${field.name} to ${field.name.replace(formRegex, `questions-${QuestionformNum}-`)}`);
                field.name = field.name.replace(formRegex, `questions-${QuestionformNum}-`);
            }
            if (field.htmlFor) { // Update label 'for' attributes
                console.log(`Updating label for from ${field.htmlFor} to ${field.htmlFor.replace(formRegex, `questions-${QuestionformNum}-`)}`);
                field.htmlFor = field.htmlFor.replace(formRegex, `questions-${QuestionformNum}-`);
            }
        });

        // Add remove button event listener
        newForm.querySelector('.remove-question').addEventListener('click', removeQuestionForm);

        question_container.appendChild(newForm);

        totalQuestionForms.setAttribute('value', `${QuestionformNum + 1}`);
    }

    function addOptionForm(e) {
        e.preventDefault();

        let newForm = optionForms[0].cloneNode(true);
        let formRegex = /options-(\d+)-/g;

        OptionformNum++;
        newForm.innerHTML = newForm.innerHTML.replace(formRegex, `options-${OptionformNum}-`);

        // Update the ID and name attributes of the new form fields
        let formFields = newForm.querySelectorAll('input, select, textarea, label');
        formFields.forEach(function(field) {
            if (field.id) {
                console.log(`Updating field id from ${field.id} to ${field.id.replace(formRegex, `options-${OptionformNum}-`)}`);
                field.id = field.id.replace(formRegex, `options-${OptionformNum}-`);
            }
            if (field.name) {
                console.log(`Updating field name from ${field.name} to ${field.name.replace(formRegex, `options-${OptionformNum}-`)}`);
                field.name = field.name.replace(formRegex, `options-${OptionformNum}-`);
            }
            if (field.htmlFor) { // Update label 'for' attributes
                console.log(`Updating label for from ${field.htmlFor} to ${field.htmlFor.replace(formRegex, `options-${OptionformNum}-`)}`);
                field.htmlFor = field.htmlFor.replace(formRegex, `options-${OptionformNum}-`);
            }
        });

        // Add remove button event listener
        newForm.querySelector('.remove-option').addEventListener('click', removeOptionForm);

        option_container.appendChild(newForm);

        totalOptionForms.setAttribute('value', `${OptionformNum + 1}`);
    }

    function removeQuestionForm(e) {
        e.preventDefault();
        let formToRemove = e.target.closest('.question-form');
        formToRemove.remove();

        // Update total forms count
        let currentForms = document.querySelectorAll('.question-form').length;
        totalQuestionForms.setAttribute('value', `${currentForms}`);
    }

    function removeOptionForm(e) {
        e.preventDefault();
        let formToRemove = e.target.closest('.option-form');
        formToRemove.remove();

        // Update total forms count
        let currentForms = document.querySelectorAll('.option-form').length;
        totalOptionForms.setAttribute('value', `${currentForms}`);
    }

    // Add remove event listeners to initial forms
    questionForms.forEach(function(form) {
        form.querySelector('.remove-question').addEventListener('click', removeQuestionForm);
    });

    // Add remove event listeners to initial forms
    optionForms.forEach(function(form) {
        form.querySelector('.remove-option').addEventListener('click', removeOptionForm);
    });
});
</script>

{% endblock %}